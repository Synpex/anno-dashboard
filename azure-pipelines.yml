trigger:
- main 

resources:
- repo: self

variables:
  dockerRegistryServiceConnection: 'DockerHubConnection'  
  imageName: 'sebastianpreis/annodashboard'  
  tag: '$(Build.BuildId)'

stages:
  - stage: Build
    displayName: Build and Test
    jobs:
      - job: Build
        displayName: Build Image
        pool:
          name: upcode-dev.at  # Specify your custom pool here
        steps:
          - checkout: self
            submodules: true

          - task: Docker@2
            displayName: Build Docker Image
            inputs:
              command: build
              dockerfile: '**/Dockerfile'
              repository: $(imageName)
              tags: |
                $(tag)

          - task: Docker@2
            displayName: Push Image to DockerHub
            inputs:
              command: push
              repository: $(imageName)
              dockerRegistryServiceConnection: $(dockerRegistryServiceConnection)
              tags: |
                $(tag)

  - stage: Test
    displayName: Run Tests on Openshift
    jobs:
      - job: DjangoTests
        displayName: Django Unit Tests
        pool:
          name: upcode-dev.at
          vmImage: 'ubuntu-latest'
        steps:
          - checkout: self
            submodules: true

          - script: |
              docker run \
                -e TEST_AZURE_ACCOUNT_KEY=$(TEST_AZURE_ACCOUNT_KEY) \
                -e TEST_AZURE_ACCOUNT_NAME=$(TEST_AZURE_ACCOUNT_NAME) \
                -e TEST_AZURE_CONTAINER=$(TEST_AZURE_CONTAINER) \
                -e TEST_DJANGO_API_KEY=$(TEST_DJANGO_API_KEY) \
                -e TEST_MONGO_DB=$(TEST_MONGO_DB) \
                -e TEST_MONGO_DB_CONNECTION_STRING=$(TEST_MONGO_DB_CONNECTION_STRING) \
                -e TEST_SQL_DB_NAME=$(TEST_SQL_DB_NAME) \
                -e TEST_SQL_HOST=$(TEST_SQL_HOST) \
                -e TEST_SQL_PASSWORD=$(TEST_SQL_PASSWORD) \
                -e TEST_SQL_USER=$(TEST_SQL_USER) \
                $(imageName):$(Build.BuildId) python manage.py test
            displayName: Run Django Unit Tests