trigger:
- main 

resources:
- repo: self

variables:
  dockerRegistryServiceConnection: 'DockerHubConnection'  
  imageName: 'sebastianpreis/annodashboard'  
  tag: '$(Build.BuildId)'

stages:
  - stage: Build
    displayName: Build and Test
    jobs:
      - job: Build
        displayName: Build Image
        pool:
          name: upcode-dev.at  # Specify your custom pool here
        steps:
          - checkout: self
            submodules: true

          - task: Docker@2
            displayName: Build Docker Image
            inputs:
              command: build
              dockerfile: '**/Dockerfile'
              repository: $(imageName)
              tags: |
                $(tag)

          - task: Docker@2
            displayName: Push Image to DockerHub
            inputs:
              command: push
              repository: $(imageName)
              dockerRegistryServiceConnection: $(dockerRegistryServiceConnection)
              tags: |
                $(tag)

  - stage: Test
    displayName: Run Tests
    jobs:
      - job: DjangoTests
        displayName: Django Unit Tests
        pool:
          name: upcode-dev.at  # Specify your custom pool here
        steps:
          - checkout: self
            submodules: true

          - script: |
              docker run $(imageName):$(tag) python manage.py test
            displayName: Run Django Unit Tests