trigger:
- main 

resources:
- repo: self

variables:
  dockerRegistryServiceConnection: 'DockerHubConnection'  
  imageName: 'sebastianpreis/annodashboard'  
  tag: '$(Build.BuildId)'

stages:
  - stage: Build
    displayName: Build and Test
    jobs:
      - job: Build
        displayName: Build Image
        pool:
          name: upcode-dev.at  # Specify your custom pool here
        steps:
          - checkout: self
            submodules: true

          - task: Docker@2
            displayName: Build Docker Image
            inputs:
              command: build
              dockerfile: '**/Dockerfile'
              repository: $(imageName)
              tags: |
                $(tag)

          - task: Docker@2
            displayName: Push Image to DockerHub
            inputs:
              command: push
              repository: $(imageName)
              dockerRegistryServiceConnection: $(dockerRegistryServiceConnection)
              tags: |
                $(tag)

  - stage: Test
    displayName: Run Unit Tests
    jobs:
      - job: DjangoTests
        displayName: Django Unit Tests
        pool:
          name: upcode-dev.at
          vmImage: 'ubuntu-latest'
        steps:
          - checkout: self
            submodules: true
          - script: |
              docker run -e DJANGO_ENV=local "$(imageName):$(tag)" python manage.py test
            displayName: Run Django Unit Tests
  - stage: Deploy
    displayName: Deploy to OpenShift
    condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))  # Deploy only if tests pass and it's the main branch
    jobs:
    - job: DeployJob
      displayName: Deploy Image to OpenShift
      pool:
        name: upcode-dev.at 
      steps:
        - checkout: none 
        - task: oc-cmd@3
          inputs:
          openshiftServiceConnection: 'OpenShift'  
          command: |
            oc new-app $(imageName):$(tag) --name=anno-dashboard
            oc set env deployment/anno-dashboard --from=configmap/uat-anno-dashboard
            oc set env deployment/anno-dashboard --from=secret/uat-anno-dashboard
            oc expose svc/anno-dashboard  # Expose the service to get an external URL
          checkForErrors: 'true'
   
      